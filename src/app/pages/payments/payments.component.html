<div class="payments-container">

  <!-- Header Section -->
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">Payments</h1>
      <p class="page-subtitle">Track and manage customer payments</p>
    </div>
    <div class="header-actions">
      <button class="btn btn-primary" (click)="toggleForm()">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
          <path d="M8 3v10M3 8h10" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
        </svg>
        Add Payment
      </button>
      <button class="btn btn-secondary" (click)="sortAsc = !sortAsc">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
          <path d="M4 6l4-4m0 0l4 4M8 2v12" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round" />
        </svg>
        {{ sortAsc ? 'Oldest → Newest' : 'Newest → Oldest' }}
      </button>
    </div>
  </div>

  <!-- Payments Table -->
  <div class="table-container">
    <table class="data-table">
      <thead>
        <tr>
          <th>Payment ID</th>
          <th>Customer</th>
          <th>Invoice No</th>
          <th>Date</th>
          <th>Amount</th>
          <th>Status</th>
          <th class="actions-column">Actions</th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let payment of sortedPayments; let i = index">
          <td><span class="payment-ref">{{ payment.paymentId }}</span></td>
          <td><span class="customer-name">{{ payment.customerName }}</span></td>
          <td><span class="invoice-ref">{{ payment.invoiceNo }}</span></td>
          <td>{{ payment.date }}</td>
          <td><span class="amount">₹{{ payment.amount | number:'1.2-2' }}</span></td>
          <td>
            <span class="badge" [ngClass]="{
              'badge-success': payment.status === 'Success',
              'badge-pending': payment.status === 'Pending',
              'badge-failed': payment.status === 'Failed'
            }">
              {{ payment.status }}
            </span>
          </td>

          <td class="actions-column">
            <div class="actions-dropdown">
              <button class="btn-action-trigger" (click)="toggleActionMenu($event, payment.id)">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                  <circle cx="8" cy="3" r="1.5" fill="currentColor" />
                  <circle cx="8" cy="8" r="1.5" fill="currentColor" />
                  <circle cx="8" cy="13" r="1.5" fill="currentColor" />
                </svg>
              </button>
              <div class="actions-menu" [class.active]="activeMenuId === payment.id">
                <button class="action-item" (click)="toggleForm(true, i); closeActionMenu()">
                  <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                    <path d="M11.333 2A1.886 1.886 0 0114 4.667l-9 9-3.667 1 1-3.667 9-9z" stroke="currentColor"
                      stroke-width="1.5" />
                  </svg>
                  Edit
                </button>
                <button class="action-item action-receipt" (click)="downloadReceipt(payment); closeActionMenu()"
                  [disabled]="payment.status !== 'Success'">
                  <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                    <path
                      d="M14 10v2.667A1.333 1.333 0 0112.667 14H3.333A1.333 1.333 0 012 12.667V10M4.667 6.667L8 10m0 0l3.333-3.333M8 10V2"
                      stroke="currentColor" stroke-width="1.5" />
                  </svg>
                  Receipt
                </button>
                <div class="action-divider"></div>
                <button class="action-item action-delete" (click)="deletePayment(payment, i); closeActionMenu()"
                  [disabled]="payment.status === 'Success'">
                  <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                    <path
                      d="M2 4h12M5.333 4V2.667a1.333 1.333 0 011.334-1.334h2.666a1.333 1.333 0 011.334 1.334V4m2 0v9.333a1.333 1.333 0 01-1.334 1.334H4.667a1.333 1.333 0 01-1.334-1.334V4h9.334z"
                      stroke="currentColor" stroke-width="1.5" />
                  </svg>
                  Delete
                </button>
              </div>
            </div>
          </td>
        </tr>

        <tr *ngIf="!sortedPayments || sortedPayments.length === 0">
          <td colspan="7" class="empty-state">
            <div class="empty-state-content">
              <svg width="48" height="48" viewBox="0 0 48 48" fill="none">
                <path d="M24 8v16m0 0l-6-6m6 6l6-6M8 32v4a4 4 0 004 4h24a4 4 0 004-4v-4" stroke="currentColor"
                  stroke-width="2" stroke-linecap="round" />
              </svg>
              <p>No payments found</p>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

</div>

<!-- ADD/EDIT PAYMENT MODAL -->
<div class="modal-overlay" *ngIf="showForm" (click)="toggleForm()">
  <div class="modal-content payment-modal" (click)="$event.stopPropagation()">

    <!-- Modal Header -->
    <div class="modal-header">
      <h2 class="modal-title">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" class="modal-icon">
          <path d="M12 2v20M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round" />
        </svg>
        {{ isEditing ? 'Update Payment' : 'Add Payment' }}
      </h2>
      <button class="modal-close" (click)="toggleForm()">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
          <path d="M15 5L5 15M5 5l10 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
        </svg>
      </button>
    </div>

    <form (ngSubmit)="savePayment()" #paymentForm="ngForm" class="payment-form">

      <!-- Customer Information Section -->
      <div class="section-card">
        <h3 class="section-header">
          <svg width="18" height="18" viewBox="0 0 18 18" fill="none">
            <path d="M15 15.75v-1.5a3 3 0 00-3-3H6a3 3 0 00-3 3v1.5M12 5.25a3 3 0 11-6 0 3 3 0 016 0z"
              stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
          Customer Information
        </h3>

        <div class="form-group">
          <label class="form-label">Customer Name <span class="required">*</span></label>
          <select class="form-select" name="customerName" [(ngModel)]="newPayment.customerName"
            (change)="onCustomerSelected(newPayment.customerName)" required>
            <option value="">Select Customer</option>
            <option *ngFor="let c of customers" [value]="c.name">{{ c.name }}</option>
          </select>
        </div>

        <div class="row-2">
          <div class="form-group">
            <label class="form-label">Company Name</label>
            <input type="text" class="form-input readonly-field" [(ngModel)]="newPayment.companyName" name="company"
              readonly />
          </div>

          <div class="form-group">
            <label class="form-label">Mobile</label>
            <input type="text" class="form-input readonly-field" [(ngModel)]="newPayment.mobile" name="mobile"
              readonly />
          </div>
        </div>

        <div class="row-2">
          <div class="form-group">
            <label class="form-label">Email</label>
            <input type="text" class="form-input readonly-field" [(ngModel)]="newPayment.email" name="email" readonly />
          </div>

          <div class="form-group">
            <label class="form-label">GSTIN</label>
            <input type="text" class="form-input readonly-field" [(ngModel)]="newPayment.gstin" name="gst" readonly />
          </div>
        </div>
      </div>

      <!-- Invoice Selection Section -->
      <div class="section-card">
        <h3 class="section-header">
          <svg width="18" height="18" viewBox="0 0 18 18" fill="none">
            <path
              d="M9 5H7a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"
              stroke="currentColor" stroke-width="1.5" />
          </svg>
          Invoice Selection
        </h3>

        <div class="form-group">
          <label class="form-label">Invoice <span class="required">*</span></label>
          <select class="form-select" [(ngModel)]="newPayment.invoiceNo" name="invoiceNo" (change)="onInvoiceSelected()"
            required>
            <option value="">Select Invoice</option>
            <option *ngFor="let inv of filteredInvoices" [value]="inv.invoiceNo">
              {{ inv.invoiceNo }} — Outstanding: ₹{{ getInvoiceOutstanding(inv.invoiceNo) | number:'1.2-2' }}
            </option>
          </select>
        </div>
      </div>

      <!-- Payment Details Section -->
      <div class="section-card">
        <h3 class="section-header">
          <svg width="18" height="18" viewBox="0 0 18 18" fill="none">
            <path d="M9 1.5v15M13.5 4.5h-6a3 3 0 000 6h3a3 3 0 010 6h-6" stroke="currentColor" stroke-width="1.5"
              stroke-linecap="round" />
          </svg>
          Payment Details
        </h3>

        <div class="row-2">
          <div class="form-group">
            <label class="form-label">Payment ID</label>
            <input type="text" class="form-input readonly-field" [(ngModel)]="newPayment.paymentId" name="paymentId"
              readonly />
          </div>

          <div class="form-group">
            <label class="form-label">Date <span class="required">*</span></label>
            <input type="date" class="form-input" [(ngModel)]="newPayment.date" name="date" required />
          </div>
        </div>

        <div class="outstanding-info">
          <div class="info-row">
            <span class="info-label">Outstanding Before:</span>
            <span class="info-value">₹{{ newPayment.outstandingBefore | number:'1.2-2' }}</span>
          </div>
          <div class="info-divider"></div>
          <div class="info-row">
            <span class="info-label">Payment Amount:</span>
            <div class="form-group" style="margin: 0;">
              <input type="number" class="form-input" [(ngModel)]="newPayment.amount" name="amount"
                [max]="newPayment.outstandingBefore" placeholder="Enter amount" required />
            </div>
          </div>
          <div class="info-divider"></div>
          <div class="info-row highlight">
            <span class="info-label">Outstanding After:</span>
            <span class="info-value">₹{{ newPayment.outstandingAfter | number:'1.2-2' }}</span>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Status <span class="required">*</span></label>
          <select class="form-select" [(ngModel)]="newPayment.status" name="status" required>
            <option value="Pending">Pending</option>
            <option value="Success">Success</option>
            <option value="Failed">Failed</option>
          </select>
        </div>
      </div>

      <!-- Modal Footer -->
      <div class="modal-footer">
        <button type="button" class="btn btn-cancel" (click)="toggleForm()">Cancel</button>
        <button type="submit" class="btn btn-save">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
            <path
              d="M13.333 7.333v6a1.333 1.333 0 01-1.333 1.334H4a1.333 1.333 0 01-1.333-1.334v-9.333A1.333 1.333 0 014 2.667h5.333"
              stroke="currentColor" stroke-width="1.5" />
          </svg>
          {{ isEditing ? 'Update' : 'Add' }} Payment
        </button>
      </div>

    </form>
  </div>
</div>